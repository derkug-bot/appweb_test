<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ESP32 SCADA Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    padding: 20px;
  }

  h1 {
    text-align: center;
    color: #00e5ff;
    margin-bottom: 30px;
  }

  .card {
    background: #1b1b1b;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0,255,255,0.2);
    margin-bottom: 30px;
  }

  .top-values {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
  }

  .value-box {
    background: #222;
    border-radius: 8px;
    padding: 15px 30px;
    text-align: center;
    box-shadow: 0 0 8px rgba(0,255,255,0.15);
    width: 150px;
    user-select: none;
  }

  .value-label {
    font-size: 14px;
    color: #66ffff;
    margin-bottom: 6px;
  }

  .value-number {
    font-size: 25px;
    color: #00e5ff;
    font-weight: bold;
  }

  canvas {
    background: #0d0d0d;
    border-radius: 6px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
  }

  th {
    background: #222;
    color: #00e5ff;
    padding: 8px;
  }

  td {
    padding: 6px;
    text-align: center;
    border-bottom: 1px solid #333;
  }

  tr:nth-child(even) { background: #181818; }

  .rssi-strong { background-color: #2e7d32; color: #fff; }
  .rssi-medium { background-color: #f9a825; }
  .rssi-weak { background-color: #c62828; color: #fff; }

  #toggleTableBtn {
    background: #00e5ff;
    border: none;
    color: #111;
    padding: 8px 14px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 10px;
  }
</style>
</head>

<body>

<h1>⚙ ESP32 SCADA Dashboard</h1>

<!-- Top values display -->
<div class="top-values">
  <div class="value-box">
    <div class="value-label">H2O Temp (°C)</div>
    <div id="valH2oT" class="value-number">--</div>
  </div>
  <div class="value-box">
    <div class="value-label">Oil Temp (°C)</div>
    <div id="valOilT" class="value-number">--</div>
  </div>
  <div class="value-box">
    <div class="value-label">S1</div>
    <div id="valS1" class="value-number">--</div>
  </div>
  <div class="value-box">
    <div class="value-label">S2</div>
    <div id="valS2" class="value-number">--</div>
  </div>
</div>

<!-- Temperature chart -->
<div class="card">
  <canvas id="scadaChart" height="120"></canvas>
</div>

<!-- Pressure chart -->
<div class="card">
  <canvas id="pressureChart" height="60"></canvas>
</div>

<!-- Toggle button for table -->
<button id="toggleTableBtn">Toggle Table</button>

<!-- Data table -->
<div class="card" id="tableContainer">
  <table id="dataTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Device</th>
        <th>RSSI</th>
        <th>Oil_T</th>
        <th>Oil_P</th>
        <th>H2o_T</th>
        <th>H2o_P</th>
        <th>S1</th>
        <th>S2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbycv7bVLQaIvbtOLZFNR-8bZ3oxm5AsqqblbtuwUJQf33r2mlcnsh-ChABJm5_Ed3XIog/exec";
const REFRESH_INTERVAL = 5000;

let tempChart;
let pressureChart;

function initTempChart() {
  const ctx = document.getElementById("scadaChart").getContext("2d");




function initPressureChart() {
  const ctx = document.getElementById("pressureChart").getContext("2d");

  pressureChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        {
          label: "Oil",
          data: [],
          borderColor: "#ff9800",
          tension: 0.3
        },
        {
          label: "Water",
          data: [],
          borderColor: "#00e5ff",
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      animation: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#fff" } }
      },
      scales: {
        x: { ticks: { color: "#aaa" } },
        y: {
          title: { display: true, text: "Pressure (psi)", color: "#fff" },
          ticks: { color: "#fff" }
        }
      }
    }
  });
}

function getRssiClass(rssi) {
  rssi = Number(rssi);
  if (rssi >= -60) return "rssi-strong";
  if (rssi >= -75) return "rssi-medium";
  return "rssi-weak";
}

async function fetchData() {
  try {
    const res = await fetch(DATA_URL);
    const data = await res.json();

    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    // Clear charts
    tempChart.data.labels = [];
    pressureChart.data.labels = [];

    tempChart.data.datasets.forEach(ds => ds.data = []);
    pressureChart.data.datasets.forEach(ds => ds.data = []);

    // Variables for top values display - last row data
    let latest = null;

    data.forEach(row => {
      const time = new Date(row.Timestamp).toLocaleTimeString();

      // --- Temperature Chart ---
      tempChart.data.labels.push(time);
      tempChart.data.datasets[0].data.push(Number(row.Oil_T));
      tempChart.data.datasets[1].data.push(Number(row.H2o_T));
      tempChart.data.datasets[2].data.push(Number(row.S1));
      tempChart.data.datasets[3].data.push(Number(row.S2));

      // --- Pressure Chart ---
      pressureChart.data.labels.push(time);
      pressureChart.data.datasets[0].data.push(Number(row.Oil_P));
      pressureChart.data.datasets[1].data.push(Number(row.H2o_P));

      // Table row
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(row.Timestamp).toLocaleTimeString()}</td>
        <td>${row.Device}</td>
        <td class="${getRssiClass(row.RSSI)}">${row.RSSI}</td>
        <td>${row.Oil_T}</td>
        <td>${row.Oil_P}</td>
        <td>${row.H2o_T}</td>
        <td>${row.H2o_P}</td>
        <td>${row.S1}</td>
        <td>${row.S2}</td>
      `;
      tbody.appendChild(tr);

      latest = row;
    });

    // Update top values with latest data or show -- if none
    if (latest) {
      document.getElementById("valH2oT").textContent = latest.H2o_T;
      document.getElementById("valOilT").textContent = latest.Oil_T;
      document.getElementById("valS1").textContent = latest.S1;
      document.getElementById("valS2").textContent = latest.S2;
    } else {
      document.getElementById("valH2oT").textContent = "--";
      document.getElementById("valOilT").textContent = "--";
      document.getElementById("valS1").textContent = "--";
      document.getElementById("valS2").textContent = "--";
    }

    tempChart.update();
    pressureChart.update();
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

initTempChart();
initPressureChart();

fetchData();
setInterval(fetchData, REFRESH_INTERVAL);

// Table toggle logic
const toggleBtn = document.getElementById("toggleTableBtn");
const tableContainer = document.getElementById("tableContainer");

toggleBtn.addEventListener("click", () => {
  if (tableContainer.style.display === "none") {
    tableContainer.style.display = "block";
  } else {
    tableContainer.style.display = "none";
  }
});
</script>

</body>
</html>
