<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ESP32 SCADA Dashboard with Gauges</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    padding: 20px;
  }

  h1 {
    text-align: center;
    color: #00e5ff;
    margin-bottom: 20px;
  }

  /* Gauges container */
  .gauges {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
  }

  .gauge-card {
    background: #1b1b1b;
    padding: 10px;
    border-radius: 8px;
    width: 22%;
    text-align: center;
    box-shadow: 0 0 10px rgba(0,255,255,0.2);
  }

  .card {
    background: #1b1b1b;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    box-shadow: 0 0 15px rgba(0,255,255,0.2);
  }

  canvas {
    background: #0d0d0d;
    border-radius: 6px;
    display: block;
    margin: 0 auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
  }

  th {
    background: #222;
    color: #00e5ff;
    padding: 8px;
  }

  td {
    padding: 6px;
    text-align: center;
    border-bottom: 1px solid #333;
  }

  tr:nth-child(even) {
    background: #181818;
  }

  .rssi-strong {
    background-color: #2e7d32;
    color: #fff;
  }

  .rssi-medium {
    background-color: #f9a825;
  }

  .rssi-weak {
    background-color: #c62828;
    color: #fff;
  }

  /* Collapsible table toggle */
  .toggle-button {
    background: #222;
    color: #00e5ff;
    padding: 6px 12px;
    cursor: pointer;
    border: none;
    margin-bottom: 8px;
    border-radius: 4px;
  }
</style>
</head>
<body>

<h1>âš™ ESP32 SCADA Dashboard</h1>

<!-- Gauges -->
<div class="gauges">
  <div class="gauge-card">
    <canvas id="gaugeH2O" width="200" height="100"></canvas>
    <div>H2O Temp</div>
  </div>
  <div class="gauge-card">
    <canvas id="gaugeOil" width="200" height="100"></canvas>
    <div>Oil Temp</div>
  </div>
  <div class="gauge-card">
    <canvas id="gaugeS1" width="200" height="100"></canvas>
    <div>S1</div>
  </div>
  <div class="gauge-card">
    <canvas id="gaugeS2" width="200" height="100"></canvas>
    <div>S2</div>
  </div>
</div>

<!-- Temperature / S1/S2 Chart -->
<div class="card">
  <canvas id="tempChart" height="120"></canvas>
</div>

<!-- Pressure Chart -->
<div class="card">
  <canvas id="pressureChart" height="80"></canvas>
</div>

<!-- Expand/Collapse Table -->
<div class="card">
  <button class="toggle-button" onclick="toggleTable()">Toggle Table</button>
  <table id="dataTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Device</th>
        <th>RSSI</th>
        <th>Oil_T</th>
        <th>Oil_P</th>
        <th>H2O_T</th>
        <th>H2O_P</th>
        <th>S1</th>
        <th>S2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbycv7bVLQaIvbtOLZFNR-8bZ3oxm5AsqqblbtuwUJQf33r2mlcnsh-ChABJm5_Ed3XIog/exec";
const REFRESH_INTERVAL = 5000;

// Center text plugin for Chart.js 4 to display gauge value inside the dial
const centerTextPlugin = {
  id: "centerText",
  beforeDraw(chart) {
    const ctx = chart.ctx;
    const width = chart.width;
    const height = chart.height;
    ctx.save();
    ctx.font = "bold 18px Arial";
    ctx.fillStyle = "#eee";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const value = chart.data.datasets[0].data[0];
    ctx.fillText(Math.round(value), width / 2, height * 0.75);
    ctx.restore();
  }
};

function createGauge(ctx, color) {
  return new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Value", "Remaining"],
      datasets: [{
        data: [0, 120],
        backgroundColor: [color, "#222"],
        borderWidth: 0
      }]
    },
    options: {
      rotation: -Math.PI,
      circumference: Math.PI,
      cutout: "70%",
      responsive: false,
      animation: false,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    },
    plugins: [centerTextPlugin]
  });
}

function updateGauge(gauge, value) {
  value = Math.min(Math.max(value, 0), 120);
  gauge.data.datasets[0].data[0] = value;
  gauge.data.datasets[0].data[1] = 120 - value;
  gauge.update();
}

let gaugeH2O, gaugeOil, gaugeS1, gaugeS2;
let tempChart, pressureChart;

function initGauges() {
  gaugeH2O = createGauge(document.getElementById("gaugeH2O"), "rgba(41,182,246,0.6)"); // soft blue
  gaugeOil = createGauge(document.getElementById("gaugeOil"), "rgba(255,82,82,0.6)"); // soft red
  gaugeS1 = createGauge(document.getElementById("gaugeS1"), "rgba(0,230,118,0.6)"); // soft green
  gaugeS2 = createGauge(document.getElementById("gaugeS2"), "rgba(255,235,59,0.6)"); // soft yellow
}

function initTempChart() {
  const ctx = document.getElementById("tempChart").getContext("2d");
  tempChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { label: "Oil Temp", data: [], borderColor: "#ff5252", tension: 0.3 },
        { label: "H2O Temp", data: [], borderColor: "#29b6f6", tension: 0.3 },
        { label: "S1", data: [], borderColor: "#00e676", tension: 0.3 },
        { label: "S2", data: [], borderColor: "#ffeb3b", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      animation: false,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { labels: { color: "#fff" } } },
      scales: {
        x: { ticks: { color: "#aaa" } },
        y: {
          title: { display: true, text: "Temperature / Sensor", color: "#fff" },
          ticks: { color: "#fff" }
        }
      }
    }
  });
}

function initPressureChart() {
  const ctx = document.getElementById("pressureChart").getContext("2d");
  pressureChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { label: "Oil Pressure", data: [], borderColor: "#ff9800", tension: 0.3 },
        { label: "H2O Pressure", data: [], borderColor: "#00e5ff", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      animation: false,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { labels: { color: "#fff" } } },
      scales: {
        x: { ticks: { color: "#aaa" } },
        y: {
          ticks: { color: "#fff" },
          title: { display: true, text: "Pressure (bar)", color: "#fff" }
        }
      }
    }
  });
}

function getRssiClass(rssi) {
  rssi = Number(rssi);
  if (rssi >= -60) return "rssi-strong";
  if (rssi >= -75) return "rssi-medium";
  return "rssi-weak";
}

function toggleTable() {
  const table = document.getElementById("dataTable");
  table.style.display = (table.style.display === "none") ? "table" : "none";
}

async function fetchData() {
  try {
    const res = await fetch(DATA_URL);
    const data = await res.json();
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    // Clear charts
    tempChart.data.labels = [];
    pressureChart.data.labels = [];
    tempChart.data.datasets.forEach(ds => ds.data = []);
    pressureChart.data.datasets.forEach(ds => ds.data = []);

    data.forEach(row => {
      const time = new Date(row.Timestamp).toLocaleTimeString();

      // Temperature chart update
      tempChart.data.labels.push(time);
      tempChart.data.datasets[0].data.push(Number(row.Oil_T));
      tempChart.data.datasets[1].data.push(Number(row.H2o_T));
      tempChart.data.datasets[2].data.push(Number(row.S1));
      tempChart.data.datasets[3].data.push(Number(row.S2));

      // Pressure chart update
      pressureChart.data.labels.push(time);
      pressureChart.data.datasets[0].data.push(Number(row.Oil_P));
      pressureChart.data.datasets[1].data.push(Number(row.H2o_P));

      // Table row
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${time}</td>
        <td>${row.Device}</td>
        <td class="${getRssiClass(row.RSSI)}">${row.RSSI}</td>
        <td>${row.Oil_T}</td>
        <td>${row.Oil_P}</td>
        <td>${row.H2o_T}</td>
        <td>${row.H2o_P}</td>
        <td>${row.S1}</td>
        <td>${row.S2}</td>
      `;
      tbody.appendChild(tr);
    });

    tempChart.update();
    pressureChart.update();

    // Update gauges with latest data
    if (data.length > 0) {
      const last = data[data.length - 1];
      updateGauge(gaugeH2O, Number(last.H2o_T));
      updateGauge(gaugeOil, Number(last.Oil_T));
      updateGauge(gaugeS1, Number(last.S1));
      updateGauge(gaugeS2, Number(last.S2));
    }
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

// Initialize everything
initGauges();
initTempChart();
initPressureChart();
fetchData();
setInterval(fetchData, REFRESH_INTERVAL);
</script>

</body>
</html>
