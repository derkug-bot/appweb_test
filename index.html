<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: center; }
  th { background-color: #333; color: #fff; }

  /* RSSI colors */
  .rssi-strong { background-color: #4caf50; color: #fff; }
  .rssi-medium { background-color: #ffeb3b; }
  .rssi-weak { background-color: #f44336; color: #fff; }

  button { padding: 5px 10px; margin: 2px; font-size: 14px; cursor: pointer; }
</style>
</head>
<body>
<h1>ESP32 Dashboard</h1>
<table id="dataTable">
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Device</th>
      <th>A1</th>
      <th>A2</th>
      <th>A3</th>
      <th>LED</th>
      <th>RSSI</th>
      <th>Sheet</th>
      <th>Control</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbwJcyPYWUSdqBmjeolqufbsv8uuRC4CPAZrPMe6Ps4v3GWmlGpwa4DRx6ovFnzpFd0Vow/exec"; // replace with your Apps Script URL
const REFRESH_INTERVAL = 5000; // 5 seconds

function getRssiClass(rssi) {
  rssi = Number(rssi);
  if (rssi >= -60) return "rssi-strong";
  if (rssi >= -75) return "rssi-medium";
  return "rssi-weak";
}

// --- Send LED command ---
function setLed(deviceId, ledValue) {
  const url = `${DATA_URL}?ledDevice=${deviceId}&led=${ledValue}`;
  fetch(url)
    .then(res => res.json())
    .then(data => {
      if(data.status === "ok") {
        alert(`LED set to ${ledValue} for device ${deviceId}`);
        fetchData(); // refresh table to show new LED state
      } else {
        alert(`Error: ${data.error || data.message}`);
      }
    })
    .catch(err => alert('Fetch error: ' + err));
}

async function fetchData() {
  try {
    const res = await fetch(DATA_URL);
    const data = await res.json();
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
      const tr = document.createElement("tr");
      const rssiClass = getRssiClass(row.RSSI);
      
      tr.innerHTML = `
        <td>${new Date(row.Timestamp).toLocaleString()}</td>
        <td>${row.Device}</td>
        <td>${row.A1}</td>
        <td>${row.A2}</td>
        <td>${row.A3}</td>
        <td>${row.LED}</td>
        <td class="${rssiClass}">${row.RSSI}</td>
        <td>${row.Sheet}</td>
        <td>
          <button onclick="setLed('${row.Device}',1)">ON</button>
          <button onclick="setLed('${row.Device}',0)">OFF</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

// Initial fetch
fetchData();

// Auto-refresh
setInterval(fetchData, REFRESH_INTERVAL);
</script>
</body>
</html>
