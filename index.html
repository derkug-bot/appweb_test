
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<meta charset="UTF-8">
<title>ESP32 Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: center; }
  th { background-color: #333; color: #fff; }

  /* RSSI colors */
  .rssi-strong { background-color: #4caf50; color: #fff; }
  .rssi-medium { background-color: #ffeb3b; }
  .rssi-weak { background-color: #f44336; color: #fff; }
</style>
</head>
<body>
  <h2>Oil Temperature Trend</h2>
<canvas id="oilTempChart"></canvas>


  <select id="sheetSelect">
  <option value="Sheet1">Sheet1</option>
  <option value="DeviceA">Sheet3</option>
  <option value="DeviceB">DeviceB</option>
</select>

  
<h1>ESP32 Dashboard</h1>
<table id="dataTable">
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Device</th>
      <th>RSSI</th>
      <th>A1</th>
      <th>A2</th>
      <th>A3</th>
      <th>A4</th>
      <th>Oil_T</th>
      <th>Oil_P</th>
      <th>H2o_T</th>
      <th>H2o_P</th>
      <th>S1</th>
      <th>S2</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
      <!-- <th>LED</th> -->
      <!-- <th>Sheet</th> -->

  
<script>
// const API_KEY = "MY_SUPER_SECRET_123"; // same as in your Apps Script
// const DATA_URL = `https://script.google.com/macros/s/AKfycbycv7bVLQaIvbtOLZFNR-8bZ3oxm5AsqqblbtuwUJQf33r2mlcnsh-ChABJm5_Ed3XIog/exec?key=${API_KEY}`;
  const DATA_URL = `https://script.google.com/macros/s/AKfycbycv7bVLQaIvbtOLZFNR-8bZ3oxm5AsqqblbtuwUJQf33r2mlcnsh-ChABJm5_Ed3XIog/exec`;

const REFRESH_INTERVAL = 5000; // 5 seconds

function getRssiClass(rssi) {
  rssi = Number(rssi); // <- force to number
  if (rssi >= -60) return "rssi-strong";    // strong signal
  if (rssi >= -75) return "rssi-medium";   // medium signal
  return "rssi-weak";                       // weak signal
}

function getDataUrl(sheetName) {
  return `https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbycv7bVLQaIvbtOLZFNR-8bZ3oxm5AsqqblbtuwUJQf33r2mlcnsh-ChABJm5_Ed3XIog/exec/exec?sheet=${sheetName}`;
}





let oilTempChart;

function createChart(labels, values) {
  const ctx = document.getElementById('oilTempChart').getContext('2d');

  if (oilTempChart) {
    oilTempChart.destroy();
  }

  oilTempChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Oil Temperature',
        data: values,
        borderColor: 'red',
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          display: true
        },
        y: {
          beginAtZero: false
        }
      }
    }
  });
}












  
async function fetchData() {
  try {
    // const res = await fetch(DATA_URL);
const sheet = document.getElementById("sheetSelect").value;
const res = await fetch(getDataUrl(sheet));

    document.getElementById("sheetSelect")
  .addEventListener("change", fetchData);

    const data = await res.json();
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
      const tr = document.createElement("tr");

      // Add RSSI class for color
      const rssiClass = getRssiClass(row.RSSI);

      tr.innerHTML = `
        <td>${new Date(row.Timestamp).toLocaleString()}</td>
        <td>${row.Device}</td>
         <td class="${getRssiClass(row.RSSI)}">${row.RSSI}</td>
        <td>${row.A1}</td>
        <td>${row.A2}</td>
        <td>${row.A3}</td>
        <td>${row.A4}</td>        
        <td>${row.Oil_T}</td>
        <td>${row.Oil_P}</td>
        <td>${row.H2o_T}</td>
        <td>${row.H2o_P}</td>
        <td>${row.S1}</td>
        <td>${row.S2}</td>
      `;
      tbody.appendChild(tr);
              // <td>${row.LED}</td>      
        // <td>${row.Sheet}</td>
    });
    const labels = [];
const oilTemps = [];

data.forEach(row => {
  labels.push(new Date(row.Timestamp).toLocaleTimeString());
  oilTemps.push(Number(row.Oil_T));
});

createChart(labels, oilTemps);

  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

// Initial fetch
fetchData();

// Auto-refresh
setInterval(fetchData, REFRESH_INTERVAL);
</script>
</body>
</html>
